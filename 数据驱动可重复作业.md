# 汪意茹
#########################################
# packages necessary
#########################################
library(tidyr)
loadings
library(dplyr)
library(tidyverse)
library(ggplot2)
library(lme4)
install.packages("visreg")
library(car)
library(emmeans)
library(RColorBrewer)
library(multcompView)
library(nlme)
library(marginaleffects)
library(piecewiseSEM)
library(rstantools)
library(multcomp)
library(treemapify)
library(relaimpo)
library(r2glmm)
library(patchwork)
library(ggpubr)
library(rstatix)
library(gridExtra)
library(MuMIn)
library(boot)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(ggfortify)
library(visreg)
################################ Statistics #########################################################################
summary(leaf_analysis)
leaf_analysis$logpar2_gs <- log(leaf_analysis$par2_gs)
leaf_analysis$logsP <- log(leaf_analysis$soil_ppmP)
leaf_analysis$logsK <- log(leaf_analysis$Soil_ppmK)
leaf_analysis$logspmass <- log(leaf_analysis$spp_live_mass)
leaf_analysis$logLA <- log(leaf_analysis$leaf_area_mm2/10^6)
leaf_analysis$fapar_obs <- (1-exp(-0.86*leaf_analysis$lai))

leafNmass_lmer <- lmer(LAI~ logsP +soil_pctN  + tmp +aridity+logsK+vpd+
                         loglma + chi + Nfix + photosynthetic_pathway +
                         (1|Taxon) + (1|Taxon:site_code) + (1|Taxon:site_code:block_fac), 
                       data = leaf_analysis)
plot(resid(leafNmass_lmer) ~ fitted(leafNmass_lmer))

leafNmass_lmer <- lmer(lai~ logsP   + tmp +aridity+logsK+vpd+
                         loglma + 
                         (1|Taxon:site_code) + (1|Taxon:site_code:block_fac), 
                       data = leaf_analysis)
isLMM?
summary(leafNmass_lmer)
Anova(leafNmass_lmer)
AIC(leafNmass_lmer) # 235.448
vif(leafNmass_lmer)

leaflai_lmer <- lmer(lai~ logsP +soil_pctN  + tmp +aridity+logspmass+loglma+
                           (1|site_code:block_fac), 
                       data = leaf_analysis)

leaffapar_lmer <- lmer(fapar_obs~ logsP +soil_pctN  + tmp +aridity+logspmass+loglma+
                         (1|site_code:block_fac), 
                       data = leaf_analysis)

write.csv(leaf_analysis, "D:/研究生学习资料/NutNet_Article-1.0./NutNet_Article-1.0.0/output/leaf_analysis.csv")

par(mfrow=c(3,4),mgp=c(1.5,0.5,0),mar=c(2.5,2.5,1.5,0.5),tcl=0.3,cex.lab=1.2)
visreg(leaflai_lmer)
visreg(leaffapar_lmer)



leafNmass_lmer <- lmer(lai~ logsP +soil_pctN  + tmp +aridity+
                         loglma +chi+
                       (1|Taxon:site_code) + (1|Taxon:site_code:block_fac), 
                       data = leaf_analysis)

leafNmass_lmer <- lm(lai~ logsP +soil_pctN  + tmp +aridity+logspmass+loglma,
                       data = leaf_analysis)
leafNmass_lmer <- lm(fapar_obs~ logsP +soil_pctN  + tmp +aridity+logspmass+loglma,
                     data = leaf_analysis)

leafNmass_lmer <- lm(lai~ logsP +soil_pctN,
                     data = leaf_analysis)

leafNmass_lmer <- lm(fapar_obs~ logsP +soil_pctN,
                     data = leaf_analysis)

leafNmass_lmer <- lm(fapar_obs~ tmp +aridity+logspmass+loglma ,
                     data = leaf_analysis)

leafNmass_lmer <- lm(log(max_cover)~ logsP +soil_pctN,
                     data = leaf_analysis)

leafNmass_lmer <- glm(log(max_cover/100)~ logsP +soil_pctN,family = binomial,
                     data = leaf_analysis)

leaf_N_Pmax_cover
################################ Statistics #########################################################################
### function to calculate relative importance for mixed models 
### from https://gist.github.com/BERENZ/e9b581a4b7160357934e
calc.relip.mm <- function(model,type = 'lmg') {
  if (!isLMM(model) & !isGLMM(model)) {
    stop('Currently supports only lmer/glmer objects', call. = FALSE)
  }
  require(lme4)
  X <- getME(model,'X')
  X <- X[ , -1]
  Y <- getME(model, 'y')
  s_resid <- sigma(model)
  s_effect <- getME(model, 'theta') * s_resid
  s2 <- sum(s_resid^2, s_effect^2)
  V <- Diagonal(x = s2, n = nrow(X))
  YX <- cbind(Y, X)
  cov_XY <- solve(t(YX) %*% solve(V) %*% as.matrix(YX))
  colnames(cov_XY) <- rownames(cov_XY) <- colnames(YX)
  importances <- calc.relimp(as.matrix(cov_XY), rela = F, type = type)
  return(importances)
}

calc.relip.boot.mm <- function(model,type = 'lmg') {
  if (!isLMM(model) & !isGLMM(model)) {
    stop('Currently supports only lmer/glmer objects', call. = FALSE)
  }
  require(lme4)
  X <- getME(model,'X')
  X <- X[ , -1]
  Y <- getME(model, 'y')
  s_resid <- sigma(model)
  s_effect <- getME(model, 'theta') * s_resid
  s2 <- sum(s_resid^2, s_effect^2)
  V <- Diagonal(x = s2, n = nrow(X))
  YX <- cbind(Y, X)
  cov_XY <- solve(t(YX) %*% solve(V) %*% as.matrix(YX))
  colnames(cov_XY) <- rownames(cov_XY) <- colnames(YX)
  bootresults <- boot.relimp(as.matrix(cov_XY), b=1000, rela = F, type = type)
  importances <- booteval.relimp(bootresults, norank=T)
  return(importances)
}

multiplot <- function(..., plotlist=NULL, cols) {
  require(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # Make the panel
  plotCols = cols                          # Number of columns of plots
  plotRows = ceiling(numPlots/plotCols) # Number of rows needed, calculated from # of cols
  
  # Set up the page
  grid.newpage()
  pushViewport(viewport(layout = grid.layout(plotRows, plotCols)))
  vplayout <- function(x, y)
    viewport(layout.pos.row = x, layout.pos.col = y)
  
  # Make each plot, in the correct location
  for (i in 1:numPlots) {
    curRow = ceiling(i/plotCols)
    curCol = (i-1) %% plotCols + 1
    print(plots[[i]], vp = vplayout(curRow, curCol ))
  }
  
}

############# load data #############################################################################

leaf_analysis <- read.csv("D:/研究生学习资料/NutNet_Article-1.0.0/NutNet_Article-1.0.0/output/traits_nofence_chi_sub.csv")
names(leaf_analysis)
length(unique(leaf_analysis$Taxon)) # 196
summary(leaf_analysis)
################### make table summarizing climate data for each site (table S1)
selected_data <- leaf_analysis %>% 
  select(site_code, latitude, longitude, tmp, aridity, par2_gs, first_nutrient_year)

calculate_mean <- function(x) if (is.numeric(x)) mean(x, na.rm = TRUE) else first(x)
summary_table <- selected_data %>%
  group_by(site_code) %>%
  summarise_all(calculate_mean)
summary_table
write.csv(summary_table, "D:/研究生学习资料/NutNet_Article-1.0./output/summary_table.csv")

######################## linear mixed effects model for Nmass #######################################
#####################################################################################################

#Hypothesis: Nmass increases with N and P addition, increases with aridity and cold tmp
########## Nmass is higher in N-fixing species and C3 species #############

names(leaf_analysis)
hist(leaf_analysis$lognmass) # normal distribution

leafNmass_lmer <- lmer(lognmass~ Ntrt_fac * Ptrt_fac * Ktrt_fac + tmp + 
                         par2_gs + loglma + chi + Nfix + photosynthetic_pathway +
                         (1|Taxon) + (1|Taxon:site_code) + (1|Taxon:site_code:block_fac), 
                       data = leaf_analysis)
plot(resid(leafNmass_lmer) ~ fitted(leafNmass_lmer))
summary(leafNmass_lmer)
Anova(leafNmass_lmer)
AIC(leafNmass_lmer) # 235.448
vif(leafNmass_lmer)

plot(leafNmass_lmer)
qqnorm(residuals(leafNmass_lmer))
qqline(residuals(leafNmass_lmer))

densityPlot(residuals(leafNmass_lmer))
shapiro.test(residuals(leafNmass_lmer)) 
outlierTest(leafNmass_lmer)

residuals <- resid(leafNmass_lmer)
hist(residuals, breaks = 20, main = "Histogram of Residuals") ## good
plot(fitted(leafNmass_lmer), residuals, xlab = "Fitted Values", ylab = "Residuals",
     main = "Residuals vs. Fitted Values")  # heteroscedasticity : none 

r.squaredGLMM(leafNmass_lmer) ## R2 mariginal: 0.46, R2 conditional : 0.83


######### Export Nmass model ####################################

Nmass_model <- data.frame(Var = c('Soil N', 'Soil P', 'Soil K+µ', 'Tg', 
                                  'PAR', 'ln LMA', 'χ', 'N fixer', 'C3/C4',
                                  'Soil N x Soil P', 'Soil N x Soil K', 'Soil P x Soil K',
                                  'Soil N x Soil P x Soil K'))
Nmass_model$df <- as.matrix(Anova(leafNmass_lmer))[1:13, 2]
Nmass_model$Slope <- c(NA, NA, NA,
                       summary(emtrends(leafNmass_lmer, ~tmp, var = "tmp"))[1, 2],
                       summary(emtrends(leafNmass_lmer, ~par2_gs, var = "par2_gs"))[1, 2],
                       summary(emtrends(leafNmass_lmer, ~loglma, var = "loglma"))[1, 2],
                       summary(emtrends(leafNmass_lmer, ~chi, var = "chi"))[1, 2],
                       NA, NA, NA, NA, NA, NA)
Nmass_model$SE <- c(NA, NA, NA,
                    summary(emtrends(leafNmass_lmer, ~tmp, var = "tmp"))[1, 3],
                    summary(emtrends(leafNmass_lmer, ~par2_gs, var = "par2_gs"))[1, 3],
                    summary(emtrends(leafNmass_lmer, ~loglma, var = "loglma"))[1, 3],
                    summary(emtrends(leafNmass_lmer, ~chi, var = "chi"))[1, 3],
                    NA, NA, NA, NA, NA, NA)
Nmass_model$p <- as.matrix(Anova(leafNmass_lmer))[1:13, 3]
Nmass_model$RelImp <- as.matrix(calc.relip.mm(leafNmass_lmer)$lmg)[1:13]
Nmass_model$RelImp <- Nmass_model$RelImp * 100
Nmass_model

write.csv(Nmass_model, "./output/Nmass_model.csv")


#### soil nitrogen effect for the tables in supplementary information 
# percentage increase of Nmass in plots receiving N compared to plots not receiving N
(summary(emmeans(leafNmass_lmer, ~Ntrt_fac))[2,2] - summary(emmeans(leafNmass_lmer, ~Ntrt_fac))[1,2])/
  summary(emmeans(leafNmass_lmer, ~Ntrt_fac))[1,2]
# 0.201442

# percentage increase of Nmass in plots receiving N but not P compared to plots not receiving N or P
(summary(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac))[2,3] - summary(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac))[1,3])/
  summary(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac))[1,3]
# 0.2516

# percentage increase of Nmass in N fixers compared to non-N fixers
(summary(emmeans(leafNmass_lmer, ~Nfix))[2,2] - summary(emmeans(leafNmass_lmer, ~Nfix))[1,2])/
  summary(emmeans(leafNmass_lmer, ~Nfix))[1,2]
# 0.7029515

# percentage increase of Nmass in C3s compared to C4s
(summary(emmeans(leafNmass_lmer, ~photosynthetic_pathway))[1,2] - summary(emmeans(leafNmass_lmer, ~photosynthetic_pathway))[2,2])/
  summary(emmeans(leafNmass_lmer, ~photosynthetic_pathway))[2,2]
# 0.889215

leaf_analysis$PKgroup[leaf_analysis$Ptrt_fac == '0' & leaf_analysis$Ktrt_fac == '0'] <- '-P, -K+µ'
leaf_analysis$PKgroup[leaf_analysis$Ptrt_fac == '1' & leaf_analysis$Ktrt_fac == '0'] <- '+P, -K+µ'
leaf_analysis$PKgroup[leaf_analysis$Ptrt_fac == '0' & leaf_analysis$Ktrt_fac == '1'] <- '-P, +K+µ'
leaf_analysis$PKgroup[leaf_analysis$Ptrt_fac == '1' & leaf_analysis$Ktrt_fac == '1'] <- '+P, +K+µ'

cld_test <- cld(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac)) ## comp slopes : plots receiving N higher than those which did not
cld_test$.group

leafnmass_letters <- data.frame(x = c(0.8, 1.2, 1.8, 2.2, 2.8, 3.2, 3.8, 4.2),
                                NPgroup = c('-P, -K+µ', '-P, -K+µ', '+P, -K+µ', '+P, -K+µ', 
                                            '-P, +K+µ', '-P, +K+µ', '+P, +K+µ', '+P, +K+µ'),
                                Ntrt_fac = c(0, 1, 0, 1, 0, 1, 0, 1),
                                y = c(2.7, 2.7, 2.7, 2.7, 2.7, 2.7, 2.8, 2.8), 
                                group = c(cld(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[1, 9],
                                          cld(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[7, 9],
                                          cld(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[3, 9],
                                          cld(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[6, 9],
                                          cld(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[2, 9],
                                          cld(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[8, 9],
                                          cld(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[4, 9],
                                          cld(emmeans(leafNmass_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[5, 9]))
leafnmass_letters$Ntrt_fac <- as.factor(leafnmass_letters$Ntrt_fac)
leafnmass_letters$letter[leafnmass_letters$group == " 1 "] <- "a"
leafnmass_letters$letter[leafnmass_letters$group == "  2"] <- "b"

#### Regression table emmeans + SE 
se_table <- summary(emmeans(leafNmass_lmer, ~Ntrt_fac * Ktrt_fac * Ptrt_fac))
se_table
se_table = as.data.frame(se_table)

se_table$PKgroup[se_table$Ptrt_fac == '0' & se_table$Ktrt_fac == '0'] <- '-P, -K+µ'
se_table$PKgroup[se_table$Ptrt_fac == '1' & se_table$Ktrt_fac == '0'] <- '+P, -K+µ'
se_table$PKgroup[se_table$Ptrt_fac == '0' & se_table$Ktrt_fac == '1'] <- '-P, +K+µ'
se_table$PKgroup[se_table$Ptrt_fac == '1' & se_table$Ktrt_fac == '1'] <- '+P, +K+µ'
names(se_table)[which(names(se_table) == "emmean")] <- "lognmass"


################ Nmass violin plot + emmean and SE ################################################
leaf_analysis$Ntrt_fac <- as.factor(leaf_analysis$Ntrt_fac)
se_table$Ntrt_fac <- as.factor(se_table$Ntrt_fac)

nmass_violin <- ggplot(data = leaf_analysis, 
                      aes(x = PKgroup, y = lognmass, fill = Ntrt_fac),position = position_dodge(width = 0.5), size = 0.1) +
  geom_violin(trim=FALSE)+
  geom_point(data = se_table, aes(x = PKgroup, y = lognmass, fill = Ntrt_fac), 
            position = position_dodge(width = 0.9), size = 3) +

  geom_errorbar(data = se_table, aes(x = PKgroup, y = lognmass, ymin = lognmass - SE, ymax = lognmass + SE, 
                                     fill = Ntrt_fac), position = position_dodge(width = 0.9), width = 0.3, size = 0.8) +

  geom_text(data = leafnmass_letters, aes(x = x, y = y, label = letter), size = 6) +
  
  scale_fill_manual(values = c("gray60", "darkseagreen"), labels = c("Ambient", "Added N")) +
  
    theme(legend.position = "right",
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 15),
          legend.background = element_rect(fill = 'white', colour = 'black'),
          axis.title.y = element_text(size = 30, colour = 'black'),
          axis.title.x = element_text(size = 30, colour = 'black'),
          axis.text.x = element_text(size = 20, colour = 'black'),
          axis.text.y = element_text(size = 20, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    labs(fill = "Soil N") +
    ylab(expression('ln ' * italic('N')['mass'])) +
    xlab('P x K treatment') 

nmass_violin
nmass_violin <- nmass_violin + theme(text = element_text(family = "Helvetica"))

############### Save as tiff with 600 dpi 
tiff("./Figures/TIFF/nmass_violin.tiff", 
       width = 30, height = 20, units = "cm", res = 800)
print(nmass_violin)
dev.off()
####### Save as PDF #####################
ggsave("./Figures/PDF/nmass_violin_plot.pdf", nmass_violin, width = 10, height = 8, units = "in")

## or as jpeg ##########################
ggsave("./Figures/nmass_violin.jpeg", plot = nmass_violin, 
       width = 30, height = 20, units = "cm")

################################## Tree map N mass ###################################################

calc.relip.mm(leafNmass_lmer)$lmg

relimp_leafnmass <- NULL
relimp_leafnmass$Factor <- c('Soil N', 'Soil P', 'Soil K+µ', 'Tg', 'PAR', 'LMA', 'χ',
                             'N2 fixation', 'C3/C4', 'Soil Interactions', 'Unexplained')
relimp_leafnmass$Importance <- as.numeric(as.character(c(calc.relip.mm(leafNmass_lmer)$lmg[1:9], 
                                                         sum(calc.relip.mm(leafNmass_lmer)$lmg[10]),
                                                         1 - sum(calc.relip.mm(leafNmass_lmer)$lmg))))

relimp_leafnmass_df <- as.data.frame(relimp_leafnmass)

tm <- treemapify(data = relimp_leafnmass_df,
                 area = "Importance", start = "topleft")
tm$x <- (tm$xmax + tm$xmin) / 2
tm$y <- (tm$ymax + tm$ymin) / 2

nmass_tm <- full_join(relimp_leafnmass_df, tm, by = "Factor")
nmass_tm$name <-c('Soil~N', 'Soil~P', 'Soil~K[+µ]', 'italic(T)[g]', 'italic(PAR)',
                  'italic(LMA)[]', 'χ', 'N[2]~fixation', 
                  'C[3]/C[4]', 'Soil~Interactions', 'Unexplained')
nmass_tm$slope <- c(1,1,1,-1, 1, 
                    -1, -1, 1, 1, 1, 1)
nmass_tm$relationship = nmass_tm$slope*nmass_tm$Importance
#nmass_tm$slope <- factor(nmass_tm$slope, levels=c("No","negative", "positive"))


nmass_tm_test <- nmass_tm %>%
  mutate(
    Importance = as.factor(Importance),
    slope = as.factor(slope)
  )

(nmass_treemap <- ggplot(nmass_tm, 
                         aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, 
                             label = name)) +
    geom_rect(aes(fill = Importance), color = "black") +
    theme(legend.title = element_text(size = 20),
          legend.text = element_text(size = 15),
          legend.position = "none",
          panel.background = element_rect(fill = 'white'),
          axis.title = element_text(colour = 'white'),
          axis.text = element_text(colour = 'white'),
          axis.ticks = element_line(colour = "white")) + 
    
    #scale_fill_manual(values = c(positive = "darkblue", negative ="red4", nothing = "lightblue"))+
    scale_fill_gradient(low = "lightcyan2", high = "lightcyan4") +
    
    geom_text(data = filter(nmass_tm, Factor == 'PAR'), 
              aes(x = x, y = y), parse = T, size = 14, color="darkblue") +
    
    geom_text(data = filter(nmass_tm, Factor == 'LMA'), 
              aes(x = x, y = y), parse = T, size = 10, color="red3") +
    
    geom_text(data = filter(nmass_tm, Factor == 'χ'), 
              aes(x = x, y = y), parse = TRUE, size = 20, color = "red3", label=expression(chi)) +
   
    geom_text(data = filter(nmass_tm, Factor == 'N2 fixation'), 
              aes(x = x, y = y), parse = T, size = 9, color="darkblue") +
    
    
    geom_text(data = filter(nmass_tm, Factor == 'Unexplained'), 
              aes(x = x, y = y), parse = T, size = 6) +
    
    geom_text(data = filter(nmass_tm, Factor == 'Tg'), 
              aes(x = x, y = y), parse = TRUE, size = 10, color="red3") +
    
    geom_text(data = filter(nmass_tm,  Factor == 'C3/C4'), 
              aes(x = x, y = y), parse = T, size = 5, color="darkblue") +
    
    geom_text(data = filter(nmass_tm,  Factor == 'Soil N'), 
              aes(x = x, y = y), parse = T, size = 5, color="darkblue") +
    
    geom_text(data = filter(nmass_tm,  Factor == 'Soil Interactions'), 
              aes(x = x, y = y), parse = T, size = 4) +
    
    ggrepel::geom_text_repel(data = filter(nmass_tm, Factor == 'Soil P' |
                                             Factor == 'Soil K+µ'), 
                             aes(x = x, y = y), parse = T, size = 5, 
                             direction = "y", xlim = c(1.01, NA)) +
    
    scale_x_continuous(limits = c(0, 1.2), expand = c(0, 0), 
                       name = "X (\U03C7)") +
    #scale_x_continuous(limits = c(0, 1.2), expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)))

nmass_treemap
nmass_treemap <- nmass_treemap + theme(text = element_text(family = "Helvetica"))

############### Save as tiff with 600 dpi 
tiff("./Figures/TIFF/nmass_treemap.tiff", 
     width = 30, height = 20, units = "cm", res = 800)
print(nmass_treemap)
dev.off()

####### Save as PDF #####################
ggsave("./Figures/PDF/nmass_treemap.pdf", nmass_treemap, width = 10, height = 8, units = "in")


######### Save as JPEG ##################################################
ggsave("./Figures/nmass_treemap.jpeg", plot = nmass_treemap, 
       width = 30, height = 20, units = "cm")


### linear mixed effects model for Narea ####################
###############################################################################
hist(leaf_analysis$lognarea) # normal distribution
leafnarea_lmer <- lmer(lognarea ~ Ntrt_fac * Ptrt_fac * Ktrt_fac + tmp + 
                         par2_gs + loglma + chi + Nfix + photosynthetic_pathway +
                         (1|Taxon) + (1|Taxon:site_code) + (1|Taxon:site_code:block_fac), 
                       data = leaf_analysis)
plot(resid(leafnarea_lmer) ~ fitted(leafnarea_lmer))
summary(leafnarea_lmer)
Anova(leafnarea_lmer)
AIC(leafnarea_lmer) ## 235.448
vif(leafnarea_lmer)

plot(leafnarea_lmer)
qqnorm(residuals(leafnarea_lmer))
qqline(residuals(leafnarea_lmer))

densityPlot(residuals(leafnarea_lmer))
shapiro.test(residuals(leafnarea_lmer))
outlierTest(leafnarea_lmer)

residuals <- resid(leafnarea_lmer)
hist(residuals, breaks = 20, main = "Histogram of Residuals") ## good
plot(fitted(leafnarea_lmer), residuals, xlab = "Fitted Values", ylab = "Residuals",
     main = "Residuals vs. Fitted Values")  # heteroscedasticity : high, when fitted values are high 

r.squaredGLMM(leafnarea_lmer) ## Conditional : 0.96, marginal: 0.87


########### Export model ###########################################
Narea_model <- data.frame(Var = c('Soil N', 'Soil P', 'Soil K+µ', 'Tg', 
                                  'PAR', 'ln LMA', 'χ', 'N fixer', 'C3/C4',
                                  'Soil N x Soil P', 'Soil N x Soil K', 'Soil P x Soil K',
                                  'Soil N x Soil P x Soil K'))
Narea_model$df <- as.matrix(Anova(leafnarea_lmer))[1:13, 2]
Narea_model$Slope <- c(NA, NA, NA,
                       summary(emtrends(leafnarea_lmer, ~tmp, var = "tmp"))[1, 2],
                       summary(emtrends(leafnarea_lmer, ~par2_gs, var = "par2_gs"))[1, 2],
                       summary(emtrends(leafnarea_lmer, ~loglma, var = "loglma"))[1, 2],
                       summary(emtrends(leafnarea_lmer, ~chi, var = "chi"))[1, 2],
                       NA, NA, NA, NA, NA, NA)
Narea_model$SE <- c(NA, NA, NA,
                    summary(emtrends(leafnarea_lmer, ~tmp, var = "tmp"))[1, 3],
                    summary(emtrends(leafnarea_lmer, ~par2_gs, var = "par2_gs"))[1, 3],
                    summary(emtrends(leafnarea_lmer, ~loglma, var = "loglma"))[1, 3],
                    summary(emtrends(leafnarea_lmer, ~chi, var = "chi"))[1, 3],
                    NA, NA, NA, NA, NA, NA)
Narea_model$p <- as.matrix(Anova(leafnarea_lmer))[1:13, 3]
Narea_model$RelImp <- as.matrix(calc.relip.mm(leafnarea_lmer)$lmg)[1:13]
Narea_model$RelImp <- Narea_model$RelImp * 100
Narea_model


write.csv(Narea_model, "./output/Narea_model.csv")

################################# Figure comparison between treatments ######################## 

#### soil nitrogen effect
# percentage increase of Narea in plots receiving N compared to plots not receiving N
(summary(emmeans(leafnarea_lmer, ~Ntrt_fac))[2,2] - summary(emmeans(leafnarea_lmer, ~Ntrt_fac))[1,2])/
  summary(emmeans(leafnarea_lmer, ~Ntrt_fac))[1,2]
# 0.2244

# percentage increase of Narea in plots receiving N but not P compared to plots not receiving N or P
(summary(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac))[2,3] - summary(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac))[1,3])/
  summary(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac))[1,3]
# 0.2810871

# percentage increase of Narea in plots receiving N and P compared to plots receiving P but not N
(summary(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac))[4,3] - summary(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac))[3,3])/
  summary(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac))[3,3]
# 0.1706608

# percentage increase of Narea in N fixers compared to non-N fixers
(summary(emmeans(leafnarea_lmer, ~Nfix))[2,2] - summary(emmeans(leafnarea_lmer, ~Nfix))[1,2])/
  summary(emmeans(leafnarea_lmer, ~Nfix))[1,2]
# 0.8040299

# percentage increase of Narea in C3s compared to C4s
(summary(emmeans(leafnarea_lmer, ~photosynthetic_pathway))[1,2] - summary(emmeans(leafnarea_lmer, ~photosynthetic_pathway))[2,2])/
  summary(emmeans(leafnarea_lmer, ~photosynthetic_pathway))[2,2]
# 1.027255

leaf_analysis$PKgroup[leaf_analysis$Ptrt_fac == '0' & leaf_analysis$Ktrt_fac == '0'] <- '-P, -K+µ'
leaf_analysis$PKgroup[leaf_analysis$Ptrt_fac == '1' & leaf_analysis$Ktrt_fac == '0'] <- '+P, -K+µ'
leaf_analysis$PKgroup[leaf_analysis$Ptrt_fac == '0' & leaf_analysis$Ktrt_fac == '1'] <- '-P, +K+µ'
leaf_analysis$PKgroup[leaf_analysis$Ptrt_fac == '1' & leaf_analysis$Ktrt_fac == '1'] <- '+P, +K+µ'

test = cld(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac)) ## comp slopes : plots receiving N higher than those which did not
test$.group

leafnarea_letters <- data.frame(x = c(0.8, 1.2, 1.8, 2.2, 2.8, 3.2, 3.8, 4.2),
                                NPgroup = c('-P, -K+µ', '-P, -K+µ', '+P, -K+µ', '+P, -K+µ', 
                                            '-P, +K+µ', '-P, +K+µ', '+P, +K+µ', '+P, +K+µ'),
                                Ntrt_fac = c(0, 1, 0, 1, 0, 1, 0, 1),
                                y = c(6.5, 6.5, 6.5, 6.5, 6.5, 6.5, 6.5, 6.5), 
                                group = c(cld(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[1, 9],
                                          cld(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[7, 9],
                                          cld(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[3, 9],
                                          cld(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[6, 9],
                                          cld(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[2, 9],
                                          cld(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[8, 9],
                                          cld(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[4, 9],
                                          cld(emmeans(leafnarea_lmer, ~Ntrt_fac * Ptrt_fac * Ktrt_fac))[5, 9]))
leafnarea_letters$Ntrt_fac <- as.factor(leafnarea_letters$Ntrt_fac)
leafnarea_letters$letter[leafnarea_letters$group == " 1 "] <- "a"
leafnarea_letters$letter[leafnarea_letters$group == "  2"] <- "b"

#### Regression table emmeans + SE 
se_table <- summary(emmeans(leafnarea_lmer, ~Ntrt_fac * Ktrt_fac * Ptrt_fac))
se_table
se_table = as.data.frame(se_table)

se_table$PKgroup[se_table$Ptrt_fac == '0' & se_table$Ktrt_fac == '0'] <- '-P, -K+µ'
se_table$PKgroup[se_table$Ptrt_fac == '1' & se_table$Ktrt_fac == '0'] <- '+P, -K+µ'
se_table$PKgroup[se_table$Ptrt_fac == '0' & se_table$Ktrt_fac == '1'] <- '-P, +K+µ'
se_table$PKgroup[se_table$Ptrt_fac == '1' & se_table$Ktrt_fac == '1'] <- '+P, +K+µ'
names(se_table)[which(names(se_table) == "emmean")] <- "lognarea"


################ Narea violin plot + emmean and SE ################################################
leaf_analysis$Ntrt_fac <- as.factor(leaf_analysis$Ntrt_fac)
se_table$Ntrt_fac <- as.factor(se_table$Ntrt_fac)

narea_violin <- ggplot(data = leaf_analysis, 
                       aes(x = PKgroup, y = lognarea, fill = Ntrt_fac),position = position_dodge(width = 0.5), size = 0.1) +
  geom_violin(trim=FALSE, outlier.color = NA)+
  geom_point(data = se_table, aes(x = PKgroup, y = lognarea, fill = Ntrt_fac), 
             position = position_dodge(width = 0.9), size = 3) +
  
  geom_errorbar(data = se_table, aes(x = PKgroup, y = lognarea, ymin = lognarea - SE, ymax = lognarea + SE, 
                                     fill = Ntrt_fac), position = position_dodge(width = 0.9), width = 0.3, size = 0.8) +
  
  geom_text(data = leafnarea_letters, aes(x = x, y = y, label = letter), size = 6) +
  
  scale_fill_manual(values = c("gray60", "darkseagreen"), labels = c("Ambient", "Added N")) +
  
  theme(legend.position = "right",
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 15),
        legend.background = element_rect(fill = 'white', colour = 'black'),
        axis.title.y = element_text(size = 30, colour = 'black'),
        axis.title.x = element_text(size = 30, colour = 'black'),
        axis.text.x = element_text(size = 20, colour = 'black'),
        axis.text.y = element_text(size = 20, colour = 'black'),
        panel.background = element_rect(fill = 'white', colour = 'black'),
        panel.grid.major = element_line(colour = "white")) +
  labs(fill = "Soil N") +
  ylab(expression('ln ' * italic('N')['area'])) +
  xlab('P x K treatment') 


narea_violin
narea_violin <- narea_violin + theme(text = element_text(family = "Helvetica"))

############### Save as tiff with 600 dpi 
tiff("./Figures/TIFF/narea_violin.tiff", 
     width = 30, height = 20, units = "cm", res = 800)
print(narea_violin)
dev.off()

####### Save as PDF #####################
ggsave("./Figures/PDF/narea_violin.pdf", narea_violin, width = 10, height = 8, units = "in")

####################### Save as jpeg ##################
ggsave("./Figures/narea_violin.jpeg", plot = narea_violin, 
       width = 30, height = 20, units = "cm")

############## save as tiff
ggsave("./Figures/narea_violin.tiff", narea_violin, 
       width = 45, height = 25, units = "cm", dpi = 600, type = "cairo")

################################## Tree map Narea ###################################################

calc.relip.mm(leafnarea_lmer)$lmg

relimp_leafnarea<- NULL
relimp_leafnarea$Factor <- c('Soil N', 'Soil P', 'Soil K+µ', 'Tg', 'PAR', 'LMA', 'χ',
                             'N2 fixation', 'C3/C4', 'Soil Interactions', 'Unexplained')
relimp_leafnarea$Importance <- as.numeric(as.character(c(calc.relip.mm(leafnarea_lmer)$lmg[1:9], 
                                                         sum(calc.relip.mm(leafnarea_lmer)$lmg[10:13]),
                                                         1 - sum(calc.relip.mm(leafnarea_lmer)$lmg))))

relimp_leafnarea_df <- as.data.frame(relimp_leafnarea)

tm <- treemapify(data = relimp_leafnarea_df,
                 area = "Importance", start = "topleft")
tm$x <- (tm$xmax + tm$xmin) / 2
tm$y <- (tm$ymax + tm$ymin) / 2

narea_tm <- full_join(relimp_leafnarea_df, tm, by = "Factor")
narea_tm$name <-c('Soil~N', 'Soil~P', 'Soil~K[+µ]', 'italic(T)[g]', 'italic(PAR)',
                  'italic(LMA)[]', 'italic(χ)', 'N[2]~fixation', 
                  'C[3]/C[4]', 'Soil~Interactions', 'Unexplained')
narea_tm$slope <- c(1,1,1,-1, 1, 
                    -1, -1, 1, 1, 1, 1)
narea_tm$relationship = narea_tm$slope*narea_tm$Importance
#nmass_tm$slope <- factor(nmass_tm$slope, levels=c("No","negative", "positive"))


narea_tm_test <- narea_tm %>%
  mutate(
    Importance = as.factor(Importance),
    slope = as.factor(slope)
  )

(narea_treemap <- ggplot(narea_tm, 
                         aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, 
                             label = name)) +
    geom_rect(aes(fill = Importance), color = "black") +
    theme(legend.title = element_text(size = 20),
          legend.text = element_text(size = 15),
          legend.position = "none",
          panel.background = element_rect(fill = 'white'),
          axis.title = element_text(colour = 'white'),
          axis.text = element_text(colour = 'white'),
          axis.ticks = element_line(colour = "white")) + 
    
    #scale_fill_manual(values = c(positive = "darkblue", negative ="red4", nothing = "lightblue"))+
    scale_fill_gradient(low = "lightcyan2", high = "lightcyan4") +
    
    geom_text(data = filter(narea_tm, Factor == 'LMA'), 
              aes(x = x, y = y), parse = T, size = 16, color="darkblue") +
    
    geom_text(data = filter(narea_tm, Factor == 'PAR'), 
              aes(x = x, y = y), parse = T, size = 8, color="darkblue") +
    
    geom_text(data = filter(narea_tm, Factor == 'Unexplained'), 
              aes(x = x, y = y), parse = T, size = 7) +
    
    geom_text(data = filter(narea_tm, Factor == 'χ'), 
              aes(x = x, y = y), parse = T, size = 14, color="red3", label=expression(chi)) +
    
    geom_text(data = filter(narea_tm, Factor == 'Tg'), 
              aes(x = x, y = y), parse = T, size = 8, color="red3") +
    
    geom_text(data = filter(narea_tm,  Factor == 'C3/C4'), 
              aes(x = x, y = y), parse = T, size = 8, color="darkblue") +
    
    geom_text(data = filter(narea_tm, Factor == 'N2 fixation'), 
              aes(x = x, y = y), parse = T, size = 4, color="darkblue") +
    
    geom_text(data = filter(narea_tm,  Factor == 'Soil N'), 
              aes(x = x, y = y), parse = T, size = 5, color="darkblue") +
    
    geom_text(data = filter(narea_tm,  Factor == 'Soil K+µ'), 
              aes(x = x, y = y), parse = T, size = 4) +
    
    ggrepel::geom_text_repel(data = filter(narea_tm, Factor == 'Soil P' | Factor == 'Soil Interactions'), 
                             aes(x = x, y = y), parse = T, size = 4, 
                             direction = "y", xlim = c(1.03, NA)) +
    scale_x_continuous(limits = c(0, 1.2), expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)))

narea_treemap <- narea_treemap + theme(text = element_text(family = "Helvetica"))

############### Save as tiff with 600 dpi 
tiff("./Figures/TIFF/narea_treemap.tiff", 
     width = 30, height = 20, units = "cm", res = 800)
print(narea_treemap)
dev.off()

####### Save as PDF #####################
ggsave("./Figures/PDF/narea_treemap.pdf", narea_treemap, width = 10, height = 8, units = "in")

############ Save as Jpeg 
ggsave("./Figures/narea_treemap.jpeg", plot = narea_treemap, 
       width = 30, height = 20, units = "cm")

############## save as tiff
ggsave("./Figures/narea_treemap.tiff", narea_treemap, 
       width = 45, height = 25, units = "cm", dpi = 600, type = "cairo")


#许丽华

################## Whitakker diagram to make Figure S1  ############################ 
library(ggplot2)
install_github("valentinitnelav/plotbiomes")
library(plotbiomes)

whittaker_plot <- whittaker_base_plot() 

whittaker_plot <- whittaker_base_plot() +

    theme(legend.position = c(0.21, 0.70),
          legend.text = element_text(size = 13),
         panel.background = element_blank(),
         #panel.grid.major = element_line(gray(0.7)),
         panel.grid.major = element_blank(),
         panel.border = element_rect(fill = NA),
         axis.title.y = element_text(size = 30, colour = 'black'),
         axis.title.x = element_text(size = 30, colour = 'black'),
         axis.text.x = element_text(size = 20, colour = 'black'),
         axis.text.y = element_text(size = 20, colour = 'black'))
whittaker_plot


################ mean tmp and precip per site ####################
calculate_mean <- function(x) if (is.numeric(x)) mean(x, na.rm = TRUE) else first(x)
diagram_points <- leaf_analysis %>%
  group_by(site_code) %>%
  summarise_all(calculate_mean)
nrow(diagram_points) #26
names(diagram_points)
diagram_points$precip.cm = diagram_points$precip.mean/10
#################################################################################

####### table for longitude and latitude transformation into degree and minute ##########

# Function to convert decimal degrees to degrees and minutes
convert_to_deg_min <- function(decimal_deg, is_latitude = TRUE) {
  deg <- floor(abs(decimal_deg))
  minutes <- round((abs(decimal_deg) - deg) * 60, 2)
  
  direction <- ifelse(is_latitude, 
                      ifelse(decimal_deg < 0, "S", "N"),
                      ifelse(decimal_deg < 0, "W", "E"))
  
  return(paste0(deg, "° ", minutes, "' ", direction))
}

# Apply the function to the lat and long columns
diagram_points$lat_deg_min <- sapply(diagram_points$Lat, convert_to_deg_min, is_latitude = TRUE)
diagram_points$long_deg_min <- sapply(diagram_points$Long, convert_to_deg_min, is_latitude = FALSE)

write.csv (diagram_points, "./output/diagram_points.csv")

#### Superimpose points on the diagram ############################
whittaker_ggplot_data <- whittaker_plot +
  geom_point(data = diagram_points, aes(x = tmp, y = precip.cm), color = "black", fill="white", pch=21, size = 3)
whittaker_ggplot_data

############### Save as tiff with 600 dpi 
tiff("./Figures/TIFF/whittaker_ggplot_data.tiff", 
     width = 30, height = 20, units = "cm", res = 800)
print(whittaker_ggplot_data)
dev.off()

####### Save as PDF #####################
ggsave("./Figures/PDF/whittaker_ggplot_data.pdf", whittaker_ggplot_data, width = 10, height = 8, units = "in")



#索子轩


#########################################
# packages necessary
#########################################

library(tidyr)
library(lme4)
library(car)
library(emmeans)
library(dplyr)
library(plyr)
library(RColorBrewer)
library(multcompView)
library(ggstatsplot)
library(tidyverse)
library(ggstatsplot)
library(ggplot2)

library(nlme)
library(marginaleffects)
library(piecewiseSEM)
library(rstantools)
library(multcomp)
library(treemapify)
library(relaimpo)
library(r2glmm)
library(patchwork)
library(ggpubr)
library(rstatix)
library(gridExtra)
library(MuMIn)
library(boot)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(ggfortify)
library(lavaan)

library(multcompView)
library(nlme)
library(cowplot)


####################### script to explore and analyse delta Nmass and Narea and delta above ground biomass between plots
#### that received N and plots that did not : N-control, NK-K, NP-P, NPK-PK ####################################

leaf_analysis <- read.csv("./output/traits_nofence_chi_sub.csv")
names(leaf_analysis)
length(unique(leaf_analysis$Taxon)) # 196
#################################### calculate Delta Nmass per Taxon  ######################################
##### if the taxa change between treatments, deltas are calculated only for the Taxon which is kept across treatments

### subset plots which did not receive N (they can be control, K, PK, P) ################## 
traits_lowN <- subset(leaf_analysis, Ntrt_fac == '0')
nrow(traits_lowN) # 894
table(traits_lowN$trt)


### subset plots which receive N (they can be N, NP, NPK, NK, NPK)
traits_highN <- subset(leaf_analysis, Ntrt_fac == '1')
nrow(traits_highN ) # 858

#################### combine low N and high N subsets##########################
Delta <- left_join(traits_lowN, traits_highN, 
                   by = c('site_code', 
                          'block_fac','Ptrt_fac', 'Ktrt_fac', 'Taxon'))
names(Delta)
nrow(Delta) ## 894

################ calculate delta: NPK-NP, N-control, NK-K, NP-P ################
Delta$delta_nmass <- ((Delta$nmass.y - Delta$nmass.x) / Delta$nmass.x) * 100
Delta$delta_narea <- ((Delta$narea.y - Delta$narea.x) / Delta$narea.x) * 100
Delta$delta_spp_live_mass <- ((Delta$spp_live_mass.y - Delta$spp_live_mass.x) / Delta$spp_live_mass.x) * 100

#### selection of high_N columns, but we will use only site characteristics and climate + taxon characteristics, don't use the other numeric columns concerning plots since they are for high N trt only ############
names(Delta)
delta_subset<- subset(Delta, select = c(1: 158, 304:314))
colnames(delta_subset) <- sub("\\.x$", "", colnames(delta_subset)) ## remove .x  
names(delta_subset)
nrow(delta_subset) # 894

hist(delta_subset$delta_nmass) #ok
hist(delta_subset$delta_narea) # horrible
hist(delta_subset$delta_spp_live_mass) # horrible

#############  remove instances where any delta values are 3 times higher than the MAD Leys et al., 2020 ##########################################
#################################################################################################################################
nrow(delta_subset) # 894
delta_nmass_mad <- mad(delta_subset$delta_nmass, na.rm = T)
delta_nmass_mad   # 33.68
delta_nmass_median <- median(delta_subset$delta_nmass, na.rm = T)
delta_nmass_median ### 21.62
delta_nmass_mean<- mean(delta_subset$delta_nmass, na.rm = T)
delta_nmass_mean ## 27.92

deltanmass_mad_data <- subset(delta_subset,
                              delta_nmass < 3 * delta_nmass_mad &
                                delta_nmass > 3 * -delta_nmass_mad)

nrow(deltanmass_mad_data) # 524 
hist(deltanmass_mad_data$delta_nmass) # normal dist
names(deltanmass_mad_data)

######################## delta nmass analysis #########################################################
#### Hyp 1: Cold temperature, drought and PAR increase deltanmass, deltanmass N-fixers < fixers, deltanmass C4 < C3 #######################
#########################################################################################################################
names(deltanmass_mad_data)
deltanmass_lmer_aridity <- lmer(delta_nmass ~tmp + aridity + par2_gs + Nfix +
                                  photosynthetic_pathway + Ptrt_fac*Ktrt_fac + 
                                  (1|Taxon) + (1|Taxon:site_code) + (1|Taxon:site_code:block_fac),data = deltanmass_mad_data)
Anova(deltanmass_lmer_aridity, type = 'II')
summary(deltanmass_lmer_aridity)


plot(resid(deltanmass_lmer_aridity) ~ fitted(deltanmass_lmer_aridity))

vif(deltanmass_lmer_aridity) # no colinearity
AIC(deltanmass_lmer_aridity) ## 4983.48

plot(deltanmass_lmer_aridity)
qqnorm(residuals(deltanmass_lmer_aridity))
qqline(residuals(deltanmass_lmer_aridity))

densityPlot(residuals(deltanmass_lmer_aridity))
shapiro.test(residuals(deltanmass_lmer_aridity)) 
outlierTest(deltanmass_lmer_aridity)

residuals <- resid(deltanmass_lmer_aridity)
hist(residuals, breaks = 20, main = "Histogram of Residuals") ## not bad

plot(fitted(deltanmass_lmer_aridity), residuals, xlab = "Fitted Values", ylab = "Residuals",
     main = "Residuals vs. Fitted Values")  # heteroscedasticity : none

r.squaredGLMM(deltanmass_lmer_aridity) ## mariginal:0.109 , conditional: 0.280, not terrible 

delta_nmass_model_aridity <- data.frame(Var = c('Tg', 'aridity', 'PAR', 'N fixer', 
                                        'C3/C4', 'Soil P', 'Soil K', 'Soil P x Soil K'))

delta_nmass_model_aridity$df <- as.matrix(Anova(deltanmass_lmer_aridity))[1:8, 2]
delta_nmass_model_aridity$Slope <- c(
  summary(emtrends(deltanmass_lmer_aridity, ~tmp, var = "tmp"))[1, 2],
  summary(emtrends(deltanmass_lmer_aridity, ~aridity, var = "aridity"))[1, 2],
  summary(emtrends(deltanmass_lmer_aridity, ~par2_gs, var = "par2_gs"))[1, 2],
  NA, NA, NA, NA, NA)
delta_nmass_model_aridity$SE <- c(
  summary(emtrends(deltanmass_lmer_aridity, ~tmp, var = "tmp"))[1, 3],
  summary(emtrends(deltanmass_lmer_aridity, ~aridity, var = "aridity"))[1, 3],
  summary(emtrends(deltanmass_lmer_aridity, ~par2_gs, var = "par2_gs"))[1, 3],
  NA, NA, NA, NA, NA)
delta_nmass_model_aridity$p <- as.matrix(Anova(deltanmass_lmer_aridity))[1:8, 3]
delta_nmass_model_aridity$RelImp <- as.matrix(calc.relip.mm(deltanmass_lmer_aridity)$lmg)[1:8]
delta_nmass_model_aridity$RelImp <- delta_nmass_model_aridity$RelImp * 100
delta_nmass_model_aridity

write.csv(delta_nmass_model_aridity, "./output/delta_nmass_model_aridity.csv")

###################### # percentage increase of delta nmass in plots receiving P compared to plots not receiving P (NP-P)
(summary(emmeans(deltanmass_lmer_aridity, ~Ptrt_fac))[2,2] - summary(emmeans(deltanmass_lmer_aridity, ~Ptrt_fac))[1,2])/
  summary(emmeans(deltanmass_lmer_aridity, ~Ptrt_fac))[1,2]
# - 0.444 : plots receiving P respond less to N addition than plots not receiving P 
## this effect is significant in the model 

# percentage increase of Nmass in N fixers compared to non-N fixers
(summary(emmeans(deltanmass_lmer_aridity, ~Nfix))[2,2] - summary(emmeans(deltanmass_lmer_aridity, ~Nfix))[1,2])/
  summary(emmeans(deltanmass_lmer_aridity, ~Nfix))[1,2]
# - 0.913: non fixers increase in deltaNmass is 91.36% greater than  fixers 
## highly significant in the model

# percentage increase of Nmass in C4 compared to C3
(summary(emmeans(deltanmass_lmer_aridity, ~photosynthetic_pathway))[2,2] - summary(emmeans(deltanmass_lmer_aridity, ~photosynthetic_pathway))[1,2])/
  summary(emmeans(deltanmass_lmer_aridity, ~photosynthetic_pathway))[1,2]
#  0.5323: C4 plants increase in delta Nmass is 50.91% greater than in C3 
# ns in the model

### assign treatment group labels
deltanmass_mad_data$PKgroup[deltanmass_mad_data$Ptrt_fac == '0' & deltanmass_mad_data$Ktrt_fac == '0'] <- '-P, -K+µ'
deltanmass_mad_data$PKgroup[deltanmass_mad_data$Ptrt_fac == '1' & deltanmass_mad_data$Ktrt_fac == '0'] <- '+P, -K+µ'
deltanmass_mad_data$PKgroup[deltanmass_mad_data$Ptrt_fac == '0' & deltanmass_mad_data$Ktrt_fac == '1'] <- '-P, +K+µ'
deltanmass_mad_data$PKgroup[deltanmass_mad_data$Ptrt_fac == '1' & deltanmass_mad_data$Ktrt_fac == '1'] <- '+P, +K+µ'


test = cld(emmeans(deltanmass_lmer_aridity, ~ Ptrt_fac * Ktrt_fac)) ## comp slopes : plots receiving P have less DeltaNmass than plots which don't receive P 
test$.group
deltanmass_letters <- data.frame(x = c(1, 2, 3, 4),
                                 PKgroup = c('-P, -K+µ', '+P, -K+µ', '-P, +K+µ', '+P, +K+µ'), 
                                 y = c(120, 120, 120, 120), 
                                 group = c(cld(emmeans(deltanmass_lmer_aridity, ~Ptrt_fac * Ktrt_fac))[3, 8],
                                           cld(emmeans(deltanmass_lmer_aridity, ~Ptrt_fac * Ktrt_fac))[1, 8],
                                           cld(emmeans(deltanmass_lmer_aridity, ~Ptrt_fac * Ktrt_fac))[4, 8],
                                           cld(emmeans(deltanmass_lmer_aridity, ~Ptrt_fac * Ktrt_fac))[2, 8]))

deltanmass_letters$letter[deltanmass_letters$group == " 1 "] <- "a"
deltanmass_letters$letter[deltanmass_letters$group == " 12"] <- "ab"
deltanmass_letters$letter[deltanmass_letters$group == "  2"] <- "b"

names(deltanmass_mad_data)


(deltanmass_plot_PK <- ggplot(data = deltanmass_mad_data, 
                           aes(x = PKgroup, y = delta_nmass, colour = factor(PKgroup))) +
    scale_colour_manual(values = c("darkblue", "skyblue", 'salmon4', 'orange')) +
    theme(legend.position = "none",
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 15),
          legend.background = element_rect(fill = 'white', colour = 'black'),
          axis.title.y = element_text(size = 40, colour = 'black'),
          axis.title.x = element_text(size = 30, colour = 'black'),
          axis.text.x = element_text(size = 20, colour = 'black'),
          axis.text.y = element_text(size = 30, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    geom_boxplot(outlier.color = NA) +
    geom_point()+
    geom_text(data = deltanmass_letters, aes(x = x, y = y, label = letter), size = 8, colour="black") +
    scale_x_discrete(limits = c('-P, -K+µ', '+P, -K+µ', '-P, +K+µ', '+P, +K+µ'))+
    labs(fill = "Soil N") +
    ylab(expression('∆'* italic('N')['mass'] * ' (%)')) +
    xlab('P x K treatment'))  
deltanmass_plot_PK

#################### deltaNmass N2 fixers ######################################################
deltanmass_mad_data$Nfix <- factor(deltanmass_mad_data$Nfix, levels = c("no", "yes"), labels = c("Non-fixers", "Fixers"))

test = cld(emmeans(deltanmass_lmer_aridity, ~ Nfix)) ## comp slopes : plots receiving P have less DeltaNmass than plots which don't receive P 
test$.group
deltanmass_letters <- data.frame(x = c(1, 2),
                                 Nfix = c('Non-fixers', 'Fixers'), 
                                 y = c(120, 120), 
                                 group = c(cld(emmeans(deltanmass_lmer_aridity, ~Nfix))[2, 7],
                                           cld(emmeans(deltanmass_lmer_aridity, ~Nfix))[1, 7]))

deltanmass_letters$letter[deltanmass_letters$group == " 1 "] <- "a"
deltanmass_letters$letter[deltanmass_letters$group == "  2"] <- "b"


names(deltanmass_mad_data)
(deltanmass_plot_Nfix <- ggplot(data = deltanmass_mad_data, 
                           aes(x = Nfix, y = delta_nmass, colour = factor(Nfix), shape = factor(Nfix))) +
    scale_colour_manual(values = c("black", "black")) +  
    scale_shape_manual(values = c(1, 8))+
                         
    theme(legend.position = "none",
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 15),
          legend.background = element_rect(fill = 'white', colour = 'black'),
          axis.title.y = element_text(size = 40, colour = 'black'),
          axis.title.x = element_text(size = 30, colour = 'black'),
          axis.text.x = element_text(size = 30, colour = 'black'),
          axis.text.y = element_text(size = 30, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    geom_boxplot(outlier.color = NA) +
    geom_point()+
    geom_point(size = 2) +
    geom_text(data = deltanmass_letters, aes(x = x, y = y, label = letter), size = 8, colour="black") +
    ylab(expression('∆'* italic('N')['mass'] * ' (%)')) +
    xlab('Nitrogen fixation'))

  deltanmass_plot_Nfix
  
####################### linear regression figures #######################
######### aridity######################
aridity.regline <- data.frame(emmeans(deltanmass_lmer_aridity,"aridity",
                                      at = list(aridity =seq(min(deltanmass_mad_data$aridity, na.rm = T), max(deltanmass_mad_data$aridity, na.rm = T), 0.01)),
                                      type = "response")) 

(aridity_plot <- ggplot(data = deltanmass_mad_data, aes(x = aridity, y = delta_nmass)) + 
    
    geom_point(aes(color = factor(PKgroup), size = delta_nmass, shape=factor(Nfix)))+
    scale_size_continuous(range = c(3, 1.5)) + # Set the range for the size of points
    #scale_color_gradient(low = "darkblue", high = "lightblue") +
    scale_colour_manual(values = c("darkblue", "skyblue", 'salmon4', 'orange')) +
    scale_shape_manual(values = c(1, 8))  +
    
    geom_smooth(data = aridity.regline, aes(y = emmean), 
                col = 'black', lwd = 2, alpha = 0.8) +
    
    geom_ribbon(data = aridity.regline, aes(y=emmean, ymin = lower.CL, ymax = upper.CL), fill = "gray", alpha = 0.3)+ 
    scale_x_continuous(limits = c(0, 2.2)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 40, colour = 'black'),
          axis.title.x = element_text(size = 40, colour = 'black'),
          axis.text.x = element_text(size = 30, colour = 'black'),
          axis.text.y = element_text(size = 30, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    ylab(expression('∆'* italic('N')['mass'] * ' (%)')) +
    xlab("MI"))

aridity_plot

######################################################################################################
################ temperature regression ############

tmp.regline <- data.frame(emmeans(deltanmass_lmer_aridity,"tmp",
                                      at = list(tmp =seq(min(deltanmass_mad_data$tmp, na.rm = T), max(deltanmass_mad_data$tmp, na.rm = T), 0.1)),
                                      type = "response")) 

(tmp_plot <- ggplot(data = deltanmass_mad_data, aes(x = tmp, y = delta_nmass)) + 
    
    geom_point(aes(color = factor(PKgroup), size = delta_nmass, shape= factor(Nfix)))+
    scale_size_continuous(range = c(3, 1.5)) + # Set the range for the size of points
   # scale_color_gradient(low = "darkblue", high = "lightblue") +
    scale_colour_manual(values = c("darkblue", "skyblue", 'salmon4', 'orange'))+
    scale_shape_manual(values = c(1, 8)) +
    
    geom_smooth(data = tmp.regline, aes(y = emmean), 
                col = 'black', lwd = 2, alpha = 0.8) +
    
    geom_ribbon(data = tmp.regline, aes(y=emmean, ymin = lower.CL, ymax = upper.CL), fill = "grey", alpha = 0.3)+ 
    
    scale_x_continuous(limits = c(3, 21)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 40, colour = 'black'),
          axis.title.x = element_text(size = 40, colour = 'black'),
          axis.text.x = element_text(size = 30, colour = 'black'),
          axis.text.y = element_text(size = 30, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    ylab(expression('∆'* italic('N')['mass'] * ' (%)')) +
    xlab(expression (italic('Tg') ['°C']))) 

tmp_plot

######################################################################################################
################ PAR regression ############

PAR.regline <- data.frame(emmeans(deltanmass_lmer_aridity,"par2_gs",
                                  at = list(par2_gs =seq(min(deltanmass_mad_data$par2_gs, na.rm = T), max(deltanmass_mad_data$par2_gs, na.rm = T), 3)),
                                  type = "response")) 

(PAR_plot <- ggplot(data = deltanmass_mad_data, aes(x = par2_gs, y = delta_nmass)) + 
    
    geom_point(aes(color = factor(PKgroup), size = delta_nmass, shape= factor(Nfix)))+
    scale_size_continuous(range = c(3, 1.5)) + # Set the range for the size of points
   # scale_color_gradient(low = "lightblue", high = "darkblue") +
    
    scale_colour_manual(values = c("darkblue", "skyblue", 'salmon4', 'orange'))+
    scale_shape_manual(values = c(1, 8)) +
    
    geom_smooth(data = PAR.regline, aes(y = emmean), 
                col = 'black', lwd = 2, alpha = 0.8) +
    
    geom_ribbon(data = PAR.regline, aes(y=emmean, ymin = lower.CL, ymax = upper.CL), fill = "gray", alpha = 0.3)+ 
    
    #scale_x_continuous(limits = c(3, 21)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 40, colour = 'black'),
          axis.title.x = element_text(size = 40, colour = 'black'),
          axis.text.x = element_text(size = 30, colour = 'black'),
          axis.text.y = element_text(size = 30, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    ylab(expression('∆'* italic('N')['mass'] * ' (%)')) +
    xlab(expression (italic('PAR')))) 


PAR_plot

############ merg regression plots 
rel_widths <- c(2, 2, 2)
merged_plot_deltanmass<- plot_grid(aridity_plot, tmp_plot, PAR_plot, ncol = 3, 
                                   align = "vh", labels = c("(a)", "(b)", "(c)"), label_size = 25,
                                   label_x = c(0.86, 0.86, 0.86), rel_widths = rel_widths)
merged_plot_deltanmass


final_plot_deltanmass <- plot_grid(
  merged_plot_deltanmass,
  plot_grid(deltanmass_plot_PK, deltanmass_plot_Nfix, ncol = 2, labels = c("(d)", "(e)"), label_size = 25, label_x = c(0.89, 0.89), rel_widths = c(0.5, 0.5)),
  ncol = 1, align = "vh", rel_heights = c(1, 1)
)

final_plot_deltanmass <- final_plot_deltanmass + theme(text = element_text(family = "Helvetica"))


############### Save as tiff with 600 dpi 
ggsave("./Figures/TIFF/final_plot_deltanmass.tiff", final_plot_deltanmass, 
       width = 45, height = 25, units = "cm", dpi = 600, type = "cairo")


############## save as jpeg
ggsave("./Figures/final_plot_deltanmass.jpeg", plot = final_plot_deltanmass, 
       width = 55, height = 30, units = "cm")

################## save as PDF 
ggsave("./Figures/final_plot_deltanmass.pdf", final_plot_deltanmass, 
       width = 45, height = 25, units = "cm")

######## Structural equation model for deltanmass and delta ABG corrected by the max cover ##################
#############################################################################################################

delta_subset$PKgroup[delta_subset$Ptrt_fac == '0' & delta_subset$Ktrt_fac == '0'] <- '-P, -K+µ'
delta_subset$PKgroup[delta_subset$Ptrt_fac == '1' & delta_subset$Ktrt_fac == '0'] <- '+P, -K+µ'
delta_subset$PKgroup[delta_subset$Ptrt_fac == '0' & delta_subset$Ktrt_fac == '1'] <- '-P, +K+µ'
delta_subset$PKgroup[delta_subset$Ptrt_fac == '1' & delta_subset$Ktrt_fac == '1'] <- '+P, +K+µ'

delta_subset$Nfix_level = 0 ## creation of a column with Nfix_level= 0 
delta_subset$Nfix_level[delta_subset$Nfix == 'yes'] = 1 
delta_subset$Nfix_level[delta_subset$Nfix == 'no'] = 0 

delta_subset$ps_level = 0 ## creation of a column with photosynthetic pathway = 0 
delta_subset$ps_level[delta_subset$photosynthetic_pathway == 'C3'] = 1 
delta_subset$ps_level[delta_subset$photosynthetic_pathway == 'C4'] = 0 

delta_nmass_mad <- mad(delta_subset$delta_nmass, na.rm = T)
delta_nmass_mad   # 33.68

delta_sem_Mad <- subset(delta_subset,
                       delta_nmass < 3 * delta_nmass_mad &
                         delta_nmass > 3 * -delta_nmass_mad)
                         
nrow(delta_sem_Mad) # 524
names(delta_sem_Mad)

subset_SEM = delta_sem_Mad [ , c(8,116,117,88,102,132,155:160)] # selection of variables to be included in the structural equation model 
names(subset_SEM)

subset_SEM <- na.omit(subset_SEM)
nrow(subset_SEM) # 384


############### Structural equation model #######################

########################### using psem ####################### 
delta_sem <- psem (
  
  lm1 <-  lm(aridity~tmp , data=subset_SEM), 
  
  lme2  <-  lme(delta_spp_live_mass~ aridity + tmp + par2_gs + Nfix_level + ps_level +Ptrt_fac*Ktrt_fac, 
                 random = ~ 1|Taxon,
                 data = subset_SEM),
  
  lme3 <-  lme(delta_nmass~ delta_spp_live_mass + aridity + tmp + par2_gs + Nfix_level + ps_level +Ptrt_fac*Ktrt_fac,
                   random = ~ 1|Taxon,
                   data = subset_SEM)
 
  
)

summary(delta_sem)
plot(delta_sem)

model_summary <- summary(delta_sem)

r_squared_lm1 <- summary(lm1)$r.squared # 0.28
r_squared_lme2 <- r.squaredGLMM(lme2) # 0.12
r_squared_lme3 <- r.squaredGLMM(lme3) # 0.15

################################# delta narea analysis ######################################
#############################################################################################

#############  remove instances where any delta values are 3 times higher than the MAD ##########################################
#################################################################################################################################
nrow(delta_subset) # 894
delta_narea_mad <- mad(delta_subset$delta_narea, na.rm = T)
delta_narea_mad   # 38.71
delta_narea_median <- median(delta_subset$delta_narea, na.rm = T)
delta_narea_median ### 11.42
delta_narea_mean<- mean(delta_subset$delta_narea, na.rm = T)
delta_narea_mean ## 37.07

deltanarea_mad_data <- subset(delta_subset,
                              delta_narea < 3 * delta_narea_mad &
                                delta_narea > 3 * -delta_narea_mad)

nrow(deltanarea_mad_data) # 443 
hist(deltanarea_mad_data$delta_narea) # normal dist

#### Hyp 1: Cold temperature and drought increase deltanmass, N fixation decreases deltanmass #######################
#########################################################################################################################
######### When using aridity index, tmp and aridity have significant effects but not par ##############
deltanarea_lmer_aridity <- lmer(delta_narea ~tmp + aridity + par2_gs + Nfix + 
                                  photosynthetic_pathway + Ptrt_fac*Ktrt_fac + 
                                  (1|Taxon) + (1|Taxon:site_code) + (1|Taxon:site_code:block_fac),
                                data = deltanarea_mad_data)
Anova(deltanarea_lmer_aridity, type = 'II') ## tmp, aridity, p, nfix, photo pathway effects
summary(deltanarea_lmer_aridity)


plot(resid(deltanarea_lmer_aridity) ~ fitted(deltanarea_lmer_aridity))

vif(deltanarea_lmer_aridity) # no colinearity
AIC(deltanarea_lmer_aridity) ## 4464.286

plot(deltanmass_lmer_aridity)
qqnorm(residuals(deltanmass_lmer_aridity))
qqline(residuals(deltanmass_lmer_aridity))

densityPlot(residuals(deltanarea_lmer_aridity))
shapiro.test(residuals(deltanarea_lmer_aridity)) 
outlierTest(deltanarea_lmer_aridity)

residuals <- resid(deltanarea_lmer_aridity)
hist(residuals, breaks = 20, main = "Histogram of Residuals") ## not bad

plot(fitted(deltanarea_lmer_aridity), residuals, xlab = "Fitted Values", ylab = "Residuals",
     main = "Residuals vs. Fitted Values")  # heteroscedasticity : none

r.squaredGLMM(deltanarea_lmer_aridity) ## Conditional: 0.20, mariginal: 0.06

############ export stat #################
delta_narea_model_aridity <- data.frame(Var = c('Tg', 'aridity', 'PAR', 'N fixer', 
                                                'C3/C4', 'Soil P', 'Soil K', 'Soil P x Soil K'))

delta_narea_model_aridity$df <- as.matrix(Anova(deltanarea_lmer_aridity))[1:8, 2]
delta_narea_model_aridity$Slope <- c(
  summary(emtrends(deltanarea_lmer_aridity, ~tmp, var = "tmp"))[1, 2],
  summary(emtrends(deltanarea_lmer_aridity, ~aridity, var = "aridity"))[1, 2],
  summary(emtrends(deltanarea_lmer_aridity, ~par2_gs, var = "par2_gs"))[1, 2],
  NA, NA, NA, NA, NA)
delta_narea_model_aridity$SE <- c(
  summary(emtrends(deltanarea_lmer_aridity, ~tmp, var = "tmp"))[1, 3],
  summary(emtrends(deltanarea_lmer_aridity, ~aridity, var = "aridity"))[1, 3],
  summary(emtrends(deltanarea_lmer_aridity, ~par2_gs, var = "par2_gs"))[1, 3],
  NA, NA, NA, NA, NA)
delta_narea_model_aridity$p <- as.matrix(Anova(deltanarea_lmer_aridity))[1:8, 3]
delta_narea_model_aridity$RelImp <- as.matrix(calc.relip.mm(deltanarea_lmer_aridity)$lmg)[1:8]
delta_narea_model_aridity$RelImp <- delta_narea_model_aridity$RelImp * 100
delta_narea_model_aridity

write.csv(delta_narea_model_aridity, "./output/delta_narea_model_aridity.csv")

###################### # percentage increase of delta narea in plots receiving P compared to plots not receiving P (NP-P)
(summary(emmeans(deltanarea_lmer_aridity, ~Ptrt_fac))[2,2] - summary(emmeans(deltanarea_lmer_aridity, ~Ptrt_fac))[1,2])/
  summary(emmeans(deltanarea_lmer_aridity, ~Ptrt_fac))[1,2]
# - 0.607 : plots receiving P respond less to N addition than plots not receiving P 
## this effect is significant in the model 

# percentage increase of Nmass in N fixers compared to non-N fixers
(summary(emmeans(deltanarea_lmer_aridity, ~Nfix))[2,2] - summary(emmeans(deltanarea_lmer_aridity, ~Nfix))[1,2])/
  summary(emmeans(deltanarea_lmer_aridity, ~Nfix))[1,2]
# - 1.124: non fixers increase in deltaNarea is 112.4 % greater than  fixers 
## highly significant in the model

# percentage increase of Nmass in C4 compared to C3
(summary(emmeans(deltanarea_lmer_aridity, ~photosynthetic_pathway))[2,2] - summary(emmeans(deltanarea_lmer_aridity, ~photosynthetic_pathway))[1,2])/
  summary(emmeans(deltanarea_lmer_aridity, ~photosynthetic_pathway))[1,2]
#  3.0006: C4 plants increase in delta Nmass is 300% greater than in C3 
# ns in the model

### assign treatment group labels
deltanarea_mad_data$PKgroup[deltanarea_mad_data$Ptrt_fac == '0' & deltanarea_mad_data$Ktrt_fac == '0'] <- '-P, -K+µ'
deltanarea_mad_data$PKgroup[deltanarea_mad_data$Ptrt_fac == '1' & deltanarea_mad_data$Ktrt_fac == '0'] <- '+P, -K+µ'
deltanarea_mad_data$PKgroup[deltanarea_mad_data$Ptrt_fac == '0' & deltanarea_mad_data$Ktrt_fac == '1'] <- '-P, +K+µ'
deltanarea_mad_data$PKgroup[deltanarea_mad_data$Ptrt_fac == '1' & deltanarea_mad_data$Ktrt_fac == '1'] <- '+P, +K+µ'


test = cld(emmeans(deltanarea_lmer_aridity, ~ Ptrt_fac * Ktrt_fac)) ## comp slopes : plots receiving P have less DeltaNmass than plots which don't receive P 
test$.group
deltanarea_letters <- data.frame(x = c(1, 2, 3, 4),
                                 PKgroup = c('-P, -K+µ', '+P, -K+µ', '-P, +K+µ', '+P, +K+µ'), 
                                 y = c(120, 120, 120, 120), 
                                 group = c(cld(emmeans(deltanarea_lmer_aridity, ~Ptrt_fac * Ktrt_fac))[3, 8],
                                           cld(emmeans(deltanarea_lmer_aridity, ~Ptrt_fac * Ktrt_fac))[1, 8],
                                           cld(emmeans(deltanarea_lmer_aridity, ~Ptrt_fac * Ktrt_fac))[4, 8],
                                           cld(emmeans(deltanarea_lmer_aridity, ~Ptrt_fac * Ktrt_fac))[2, 8]))

deltanarea_letters$letter[deltanarea_letters$group == " 1"] <- "a"
### no difference in the slopes 

(deltanarea_plot <- ggplot(data = deltanarea_mad_data, 
                           aes(x = PKgroup, y = delta_narea, colour = factor(PKgroup))) +
    scale_colour_manual(values = c("darkblue", "skyblue", 'salmon4', 'orange'))+
    theme(legend.position = "none",
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 15),
          legend.background = element_rect(fill = 'white', colour = 'black'),
          axis.title.y = element_text(size = 30, colour = 'black'),
          axis.title.x = element_text(size = 30, colour = 'black'),
          axis.text.x = element_text(size = 20, colour = 'black'),
          axis.text.y = element_text(size = 20, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    geom_boxplot(outlier.color = NA) +
    geom_text(data = deltanarea_letters, aes(x = x, y = y, label = letter), size = 6, colour="black") +
    #scale_fill_manual(values = c("gray40", "darkgreen"), labels = c("Ambient", "Added N")) +
    geom_point()+
    scale_x_discrete(limits = c('-P, -K+µ', '+P, -K+µ', '-P, +K+µ', '+P, +K+µ'))+
    labs(fill = "Soil N") +
    ylab(expression('∆'* italic('N')['area']))  +
    xlab('P x K treatment'))

#################### deltaNarea N2 fixers

deltanarea_mad_data$Nfix <- factor(deltanarea_mad_data$Nfix, levels = c("no", "yes"), labels = c("Non-fixers", "Fixers"))

test = cld(emmeans(deltanarea_lmer_aridity, ~ Nfix)) ## comp slopes : plots receiving P have less DeltaNmass than plots which don't receive P 
test$.group
deltanarea_letters <- data.frame(x = c(1, 2),
                                 Nfix = c('Non-fixers', 'Fixers'), 
                                 y = c(150, 150), 
                                 group = c(cld(emmeans(deltanarea_lmer_aridity, ~Nfix))[2, 7],
                                           cld(emmeans(deltanarea_lmer_aridity, ~Nfix))[1, 7]))

deltanarea_letters$letter[deltanarea_letters$group == " 1 "] <- "a"
deltanarea_letters$letter[deltanarea_letters$group == "  2"] <- "b"


(deltanarea_plot_Nfix <- ggplot(data = deltanarea_mad_data, 
                                aes(x = Nfix, y = delta_narea, colour = factor(Nfix), shape = factor(Nfix))) +
    scale_colour_manual(values = c("black", "black")) +  
    scale_shape_manual(values = c(1, 8))+
    
    theme(legend.position = "none",
          legend.title = element_text(size = 20),
          legend.text = element_text(size = 15),
          legend.background = element_rect(fill = 'white', colour = 'black'),
          axis.title.y = element_text(size = 40, colour = 'black'),
          axis.title.x = element_text(size = 30, colour = 'black'),
          axis.text.x = element_text(size = 30, colour = 'black'),
          axis.text.y = element_text(size = 30, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    geom_boxplot(outlier.color = NA) +
    geom_point()+
    geom_point(size = 2) +
    geom_text(data = deltanarea_letters, aes(x = x, y = y, label = letter), size = 8, colour="black") +
    ylab(expression('∆'* italic('N')['area'] * ' (%)')) +
    xlab('Nitrogen fixation'))

deltanarea_plot_Nfix

####################### linear regression figures #######################
######### aridity
aridity.regline <- data.frame(emmeans(deltanarea_lmer_aridity,"aridity",
                                      at = list(aridity =seq(min(deltanarea_mad_data$aridity, na.rm = T), max(deltanarea_mad_data$aridity, na.rm = T), 0.01)),
                                      type = "response")) 

(aridity_plot_naraea <- ggplot(data = deltanarea_mad_data, aes(x = aridity, y = delta_narea)) + 
    
    geom_point(aes(color = factor(PKgroup), size = delta_narea, shape = factor(Nfix)))+
    scale_size_continuous(range = c(3, 1.5)) + 
    #scale_color_gradient(low = "darkblue", high = "lightblue") +
  
    scale_colour_manual(values = c("darkblue", "skyblue", 'salmon4', 'orange'))+
    scale_shape_manual(values = c(1,8))  +
    
    geom_smooth(data = aridity.regline, aes(y = emmean), 
                col = 'black', lwd = 2, alpha = 0.8) +
    
    geom_ribbon(data = aridity.regline, aes(y=emmean, ymin = lower.CL, ymax = upper.CL), fill = "gray", alpha = 0.3)+ 
    scale_x_continuous(limits = c(0, 2.2)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 40, colour = 'black'),
          axis.title.x = element_text(size = 40, colour = 'black'),
          axis.text.x = element_text(size = 30, colour = 'black'),
          axis.text.y = element_text(size = 30, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    ylab(expression('∆'* italic('N')['area'] * ' (%)')) +
    xlab("MI"))

aridity_plot_naraea

######################################################################################################
################ temperature regression ############

tmp.regline <- data.frame(emmeans(deltanarea_lmer_aridity,"tmp",
                                  at = list(tmp =seq(min(deltanarea_mad_data$tmp, na.rm = T), max(deltanarea_mad_data$tmp, na.rm = T), 0.1)),
                                  type = "response")) 

(tmp_plot_narea <- ggplot(data = deltanarea_mad_data, aes(x = tmp, y = delta_narea)) + 
    
    geom_point(aes(color = factor(PKgroup), size = delta_narea, shape=factor(Nfix)))+
    scale_size_continuous(range = c(3, 1.5)) + # Set the range for the size of points
   # scale_color_gradient(low = "darkblue", high = "lightblue") +
    scale_colour_manual(values = c("darkblue", "skyblue", 'salmon4', 'orange'))+
    scale_shape_manual(values = c(1,8))  +
    geom_smooth(data = tmp.regline, aes(y = emmean), 
                col = 'black', lwd = 2, alpha = 0.8) +
    
    geom_ribbon(data = tmp.regline, aes(y=emmean, ymin = lower.CL, ymax = upper.CL), fill = "gray", alpha = 0.3)+ 
    scale_x_continuous(limits = c(3, 21)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 40, colour = 'black'),
          axis.title.x = element_text(size = 40, colour = 'black'),
          axis.text.x = element_text(size = 30, colour = 'black'),
          axis.text.y = element_text(size = 30, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    ylab(expression('∆'* italic('N')['area'] * ' (%)')) +
    xlab(expression (italic('Tg') ['°C'])))

tmp_plot_narea

##########################################################################################################

################ PAR regression ############

PAR.regline <- data.frame(emmeans(deltanarea_lmer_aridity,"par2_gs",
                                  at = list(par2_gs =seq(min(deltanarea_mad_data$par2_gs, na.rm = T), max(deltanarea_mad_data$par2_gs, na.rm = T), 3)),
                                  type = "response")) 

(PAR_plot_narea <- ggplot(data = deltanarea_mad_data, aes(x = par2_gs, y = delta_narea)) + 
    
    geom_point(aes(color = factor(PKgroup), size = delta_narea, shape=factor(Nfix)))+
    scale_size_continuous(range = c(1.5, 3)) + # Set the range for the size of points
    # scale_color_gradient(low = "darkblue", high = "lightblue") +
    scale_colour_manual(values = c("darkblue", "skyblue", 'salmon4', 'orange'))+
    scale_shape_manual(values = c(1,8))  +
    geom_smooth(data = PAR.regline, aes(y = emmean), 
                col = 'black', lwd = 2, alpha = 0.8) +
    
    geom_ribbon(data = PAR.regline, aes(y=emmean, ymin = lower.CL, ymax = upper.CL), fill = "gray", alpha = 0.3)+ 
    #scale_x_continuous(limits = c(3, 21)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 40, colour = 'black'),
          axis.title.x = element_text(size = 40, colour = 'black'),
          axis.text.x = element_text(size = 30, colour = 'black'),
          axis.text.y = element_text(size = 30, colour = 'black'),
          panel.background = element_rect(fill = 'white', colour = 'black'),
          panel.grid.major = element_line(colour = "white")) +
    ylab(expression('∆'* italic('N')['area'] * ' (%)')) +
    xlab(expression (italic('PAR'))))

PAR_plot_narea


################ merge regression plots 
rel_widths <- c(2, 2, 2)
merged_plot_deltanarea<- plot_grid(aridity_plot_naraea, tmp_plot_narea, PAR_plot_narea, ncol = 3, 
                                   align = "vh", labels = c("(a)", "(b)", "(c)"), label_size = 25, 
                                   label_x = c(0.86, 0.86, 0.88), rel_widths = rel_widths)
merged_plot_deltanarea


final_plot_delta_narea <- plot_grid(
  merged_plot_deltanarea,
  plot_grid(deltanarea_plot, deltanarea_plot_Nfix, ncol = 2, labels = c("(d)", "(e)"), label_size = 25, label_x = c(0.9, 0.9), rel_widths = c(0.5, 0.5)),
  ncol = 1, align = "vh", rel_heights = c(1, 1)
)

final_plot_delta_narea

final_plot_delta_narea <- final_plot_delta_narea + theme(text = element_text(family = "Helvetica"))


############### Save as tiff with 600 dpi 
ggsave("./Figures/TIFF/final_plot_delta_narea.tiff", final_plot_delta_narea, 
       width = 45, height = 25, units = "cm", dpi = 600, type = "cairo")


############## save as jpeg
ggsave("./Figures/final_plot_delta_narea.jpeg", plot = ffinal_plot_delta_narea, 
       width = 55, height = 30, units = "cm")

################## save as PDF 
ggsave("./Figures/final_plot_delta_narea.pdf", final_plot_delta_narea, 
       width = 45, height = 25, units = "cm")


#吉晓薇

################################################# Processing  ##########################################
traits <-read.csv("./output/biomass_core_leaf_spei_final.csv")
########################################################################################################
names(traits)
nrow(traits) # 2788

traits$Ntrt_fac <- as.factor(traits$Ntrt)
traits$Ptrt_fac <- as.factor(traits$Ptrt)
traits$Ktrt_fac <- as.factor(traits$Ktrt)
traits$block_fac <- as.factor(traits$block)
traits$trt_fac <- as.factor(traits$trt)

## add in photosynthetic pathway information
levels(as.factor(traits$Family)) # check Amaranthaceae, Asteraceae, Boraginaceae, Caryophyllaceae, Cyperaceae, Euphorbiaceae,
# Polygonaceae, Poaceae, Scrophulariaceae
# only one!
# C4
#traits$photosynthetic_pathway ='NULL'
traits$photosynthetic_pathway[traits$photosynthetic_pathway == 'NULL'
                              & traits$Family == 'Cyperaceae' & traits$Taxon == 'FIMBRISTYLIS DICHOTOMA'] <- 'C4'

traits$photosynthetic_pathway[traits$photosynthetic_pathway == 'NULL'] <- 'C3'

table(traits$photosynthetic_pathway)
## C4 : 521
## C3: 2267

### calculate SLA #############
traits$sla_m2_g = traits$SLA_v2 * (1/1000000)
hist(traits$sla_m2_g)

### calculate LMA #############
traits$lma = 1/traits$sla_m2_g
hist(traits$lma) # some extremely high values

### calculate narea #############
traits$narea = (traits$leaf_pct_N / 100) * (traits$lma)
hist(traits$narea) # some extremely high values

### calculate nmass #############
traits$nmass = traits$leaf_pct_N
hist(traits$nmass)
hist(traits$leaf_pct_N)

### calculate N: P ratio in leaves #############
traits$leaf_pct_P = traits$leaf_ppm_P/10000 ## transform into percentage
traits$leaf_N_P = traits$leaf_pct_N/traits$leaf_pct_P

### calculate C: N ratio in leaves #############
traits$leaf_N_C = traits$leaf_pct_C/traits$leaf_pct_N


### calculate lai per plot #############
traits$lai = -log(traits$Ground_PAR / traits$Ambient_PAR) / 0.86 # from: http://manuals.decagon.com/Manuals/10242_Accupar%20LP80_Web.pdf page 41
hist(traits$lai)

### calculate par per leaf area to assume par absorbed is reduced in dense canopies: calculation per plot
traits$par_per_leaf_area = traits$par2_gs * ((1 - exp(-0.5 * traits$lai)) / traits$lai) # from Dong et al. (2007) eqn 2
hist(traits$par_per_leaf_area)

### calculate biomass for each species depending on the percentage max-cover for each species ###############
traits$spp_live_mass = traits$live_mass * (traits$max_cover / 100)
hist(traits$spp_live_mass)


## calculate big delta C13 from small delta 
traits$delta = ((-0.008 - traits$leaf_C13_delta_PDB * 0.001) / (1 + traits$leaf_C13_delta_PDB * 0.001)) * 1000
hist(traits$delta)

##### calculate chi for C3 plants #################### 
traits$chi[traits$photosynthetic_pathway == 'C3'] = 
  (traits$delta[traits$photosynthetic_pathway == 'C3'] * 0.001 - 0.0044) / (0.027 - 0.0044)
hist(traits$chi)

##### calculate chi for C4 plants #################### 
traits$chi[traits$photosynthetic_pathway == 'C4'] = 
  (traits$delta[traits$photosynthetic_pathway == 'C4'] * 0.001 - 0.0044) / ((-0.0057 + 0.03*0.4) - 0.0044)


hist(traits$chi)

#### create a new column for fence #################
traits$fence <- 'no'
traits$fence[traits$trt == 'Fence' | traits$trt == 'NPK+Fence'] <- 'yes'

################### transform some variables into log to get normal distribution #####################################

traits$loglma <- log(traits$lma)
hist(traits$loglma)

traits$lognarea <- log(traits$narea)
hist(traits$lognarea)

traits$lognmass <- log(traits$nmass)
hist(traits$lognmass)

names(traits)
traits$log_spp_live_mass <- log(traits$spp_live_mass)
hist(traits$log_spp_live_mass)

traits$aridity <- traits$p_pet
#################### exclude C points where chi is higher than 0.1 and lower than 0.95 ######### 
traits_chi_sub <- subset(traits, chi > 0.1 & chi < 0.95)
nrow(traits_chi_sub) ### 2106

table(traits_chi_sub$pft) ### 162 C4 remains 
hist(traits_chi_sub$chi) # quasi normal distribution 
hist(traits_chi_sub$p_pet) 

nrow(traits_chi_sub) # 2106
min(traits_chi_sub$chi) # 0.114 
max(traits_chi_sub$chi) # 0.938

length(unique(traits_chi_sub$Taxon)) # 207 species 
length(unique(traits_chi_sub$site_code)) # 26 sites

################# exclusion of fence plots  ###########################
unique(traits_chi_sub$trt)
unique(traits_chi_sub$fence)

## exclusion of fence treatments 
traits_nofence_chi_sub = subset(traits_chi_sub, fence == "no")
traits_nofence_chi_sub$fence
nrow(traits_nofence_chi_sub) ## 1752
length(unique(traits_nofence_chi_sub$Taxon)) # 196 species 
length(unique(traits_chi_sub$site_code)) # 26 sites

min(traits_chi_sub$aridity) # 0.14
max(traits_chi_sub$aridity) # 2.32

write.csv(traits, "./output/traits.csv")
write.csv(traits_chi_sub, "./output/traits_chi_sub.csv")
write.csv(traits_nofence_chi_sub, "./output/traits_nofence_chi_sub.csv")
=======

#李鑫



# create leaf trait dataset for analyses

#########################################
# packages necessary
#########################################
library(tidyr)
library(dplyr)
library(plyr)
library(ggplot2)

#################### load data containing leaf traits (Jen Firn) ####################################################################
#####################################################################################################################################

leaf_traits = read.csv("./input/NutNet-foliar-traits-7JAN2017.csv")
names(leaf_traits)
nrow(leaf_traits) ## 2764
length (unique(leaf_traits$site_code)) # 27 sites
length (unique(leaf_traits$Taxon)) # 244 species 
length (unique(leaf_traits$trt)) # 10 trt
table(leaf_traits$site_code, leaf_traits$block)

block_counts <- leaf_traits %>% 
  group_by(site_code) %>% 
  summarise(num_blocks = n_distinct(block))
View(block_counts)
## each site contains at least three blocks (except bldr.us which has 2 blocks), each block contains different plots corresponding to different trt.
## in each trt we have leaf data for different species, the number and type of species vary between plots 

##################### load data containing SLA version 2 ##################### 
leaf_v2 =  read.csv("./input/foliar_cover_updated_2.csv")
names(leaf_v2)
nrow(leaf_v2) ## 2664
length (unique(leaf_v2$site_code)) # 27 sites
length (unique(leaf_v2$Taxon)) # 243 species 
length (unique(leaf_v2$trt)) # 10 trt

leaf_new_sla = leaf_v2[, c(1:5, 13,29:35)]  # selection of site_code, plot, year, Taxon, block, SLA_v2 
leaf = left_join(leaf_traits, leaf_new_sla) ### join by Taxon, site_code, year, block, plot 
names(leaf)
names(leaf_new_sla)


leaf[leaf == 'NULL'] <- NA ## replace cells with NULL by NA

leaf[, 8:38] <- sapply(leaf[, 8:38], as.numeric) ## set columns with measurements to numeric 
sapply(leaf, class) ## verify the data types for each column
summary(leaf)

leaf$Ntrt = 0 ## creation of a column with Ntrt= 0 
leaf$Ntrt[leaf$trt == 'N' | leaf$trt == 'NP' | leaf$trt == 'NK' | leaf$trt == 'NPK' | leaf$trt == 'NPK+Fence'] = 1 ## set Ntrt=1 if any point receives N
### repeat the same for the other treatments 
leaf$Ptrt = 0
leaf$Ptrt[leaf$trt == 'P' | leaf$trt == 'NP' | leaf$trt == 'PK' | leaf$trt == 'NPK' | leaf$trt == 'NPK+Fence'] = 1
leaf$Ktrt = 0
leaf$Ktrt[leaf$trt == 'K' | leaf$trt == 'NK' | leaf$trt == 'PK' | leaf$trt == 'NPK' | leaf$trt == 'NPK+Fence'] = 1

leaf$Nfix = 'no' ## creation of a column with Nfix as no
leaf$Nfix[leaf$Family == 'Fabaceae'] = 'yes' ## when the families are Fabaceae, set them as N fixers, the other families as non fixers

write.csv(leaf, "./output/leaf.csv")
#######################################################################################################################################

#################### load data containing biomass and cover percentage ####################################################################
#####################################################################################################################################
#### This file contains information on species richness, percentage cover, biomass for each plot (not per species but per plot)

core =  read.csv("./input/comb-by-plot-09-April-2018.csv")
names(core) 
nrow(core) ## 14939
length (unique(core$site_code)) # 100 sites

core[core == 'NULL'] <- NA ## replace NULL by NA

core[, 26:45] <- sapply(core[, 26:45], as.numeric) # set columns with measurements as numeric
sapply(core, class)

core$par_rat = core$Ground_PAR / core$Ambient_PAR ### calculate the ratio of ground PAR over Ambiant PAR 
core$LAI = -log(core$Ground_PAR / core$Ambient_PAR)/0.5 ### calculate the ratio of ground PAR over Ambiant PAR 

#### selection of the columns: site_code, year, block, plot, trt, from sum_INT_cover to the end 
core_data = core[, c(2, 25, 15, 16, 22, 26:47)]  

#### selection of the columns: site_code, block, plot, trt, site_name, lat,long and other columns containing information
### about each site
core_info = core[, c(2, 15, 16, 22, 1, 3:14, 17:21, 23, 24)]


############## merge leaf with core data for each site/year/block/plot/trt  ##########################
leaf_core_data = join(leaf, core_data, by = c("site_code", "year", "block", "plot", "trt"), type = 'left', match = 'first')

leaf_core = join(leaf_core_data, core_info, by = c("site_code", "block", "plot", "trt"), type = 'left', match = 'first')

write.csv (leaf_core, "./output/leaf_core.csv")
##### here for each species in the same plot: same data of core for the whole plot, no data of biomass or PAR per species 
##########################################################################################################################


########################################### load and add climate data to leaf_core #########################################################

spei = read.csv("./input/CRU-annual_2018-07-06.csv")
names(spei)   ## this file contains for each site the annual data from 1903 to 2016 of precip, PET and SPEI-6,SPEI-12, SPEI-24
table(spei$year)
spei$p_pet = spei$precip / spei$PET  ### Calculate aridity Index 
sapply(spei, class)

## precip_mean and pet_mean in the file SPEI are  averages for the period 1975-2016
leaf_core_spei = join(leaf_core, spei, by = c("site_code", "year"), type = 'left', match = 'first')
names(leaf_core_spei)

write.csv(leaf_core_spei, "./output/leaf_core_spei.csv")

# check
nrow(leaf) # 2788
nrow(leaf_core) ## 2788
nrow(leaf_core_spei) ## 2788

######################################## load growing season climate data: temperature, par, vpd, z  average for the period 1901-2015 ###################
## these data are for each longitude and latitude, .... ########################### 

tmp_globe = read.csv("./input/cru_tmp_climExtract_growingseason_globe.csv")
par_globe = read.csv("./input/cru_par_climExtract_growingseason_globe.csv")
vpd_globe = read.csv("./input/cru_vpd_climExtract_growingseason_globe.csv")
z_globe =  read.csv("./input/z_globe.csv")

leaf_core_spei$tmp = NA
leaf_core_spei$par = NA
leaf_core_spei$vpd = NA
leaf_core_spei$z = NA

climate_df = c()
for (i in 1:nrow(leaf_core_spei)){
  
  currentLat = leaf_core_spei$latitude[i]
  currentLon = leaf_core_spei$longitude[i]
  
  clim_comb = tmp_globe
  latClim = clim_comb[ , 3]
  lonClim = clim_comb[ , 2]
  
  best_lat_pos=which(abs(latClim-currentLat)==min(abs(latClim-currentLat)))
  best_lat=latClim[best_lat_pos[1]]
  best_lon_pos=which(abs(subset(clim_comb, lat== best_lat)$lon-currentLon)==min(abs(subset(clim_comb, lat== best_lat)$lon-currentLon)))
  best_lon=subset(clim_comb, lat== best_lat)$lon[best_lon_pos[1]]
  
  tmp = subset(clim_comb, lat==best_lat & lon==best_lon)$tmp
  
  clim_comb = par_globe
  latClim = clim_comb[ , 3]
  lonClim = clim_comb[ , 2]
  
  best_lat_pos=which(abs(latClim-currentLat)==min(abs(latClim-currentLat)))
  best_lat=latClim[best_lat_pos[1]]
  best_lon_pos=which(abs(subset(clim_comb, lat== best_lat)$lon-currentLon)==min(abs(subset(clim_comb, lat== best_lat)$lon-currentLon)))
  best_lon=subset(clim_comb, lat== best_lat)$lon[best_lon_pos[1]]
  
  par = subset(clim_comb, lat==best_lat & lon==best_lon)$par
  
  clim_comb = vpd_globe
  latClim = clim_comb[ , 3]
  lonClim = clim_comb[ , 2]
  
  best_lat_pos=which(abs(latClim-currentLat)==min(abs(latClim-currentLat)))
  best_lat=latClim[best_lat_pos[1]]
  best_lon_pos=which(abs(subset(clim_comb, lat== best_lat)$lon-currentLon)==min(abs(subset(clim_comb, lat== best_lat)$lon-currentLon)))
  best_lon=subset(clim_comb, lat== best_lat)$lon[best_lon_pos[1]]
  
  vpd = subset(clim_comb, lat==best_lat & lon==best_lon)$vpd
  
  clim_comb = z_globe
  latClim = clim_comb[ , 3]
  lonClim = clim_comb[ , 2]
  
  best_lat_pos=which(abs(latClim-currentLat)==min(abs(latClim-currentLat)))
  best_lat=latClim[best_lat_pos[1]]
  best_lon_pos=which(abs(subset(clim_comb, lat== best_lat)$lon-currentLon)==min(abs(subset(clim_comb, lat== best_lat)$lon-currentLon)))
  best_lon=subset(clim_comb, lat== best_lat)$lon[best_lon_pos[1]]
  
  z = subset(clim_comb, lat==best_lat & lon==best_lon)$z
  
  climate_df = rbind(climate_df, c(tmp, par, vpd, z, currentLat, currentLon, best_lat, best_lon, i))
  
  
}

plot(climate_df[,6] ~ climate_df[,8]) # longitude match verification
plot(climate_df[,5] ~ climate_df[,7]) # latitude match verification

leaf_core_spei$tmp = climate_df[, 1] # tmp extraction from climate_df + addition to leaf_core_spei df
leaf_core_spei$par = climate_df[, 2] # par extraction from climate_df + addition to leaf_core_spei df
leaf_core_spei$vpd = climate_df[, 3] # vpd extraction from climate_df + addition to leaf_core_spei df
leaf_core_spei$z = climate_df[, 4] # elevation extraction from climate_df + addition to leaf_core_spei df
names(leaf_core_spei)

write.csv(leaf_core_spei, "./output/leaf_core_spei.csv")

########################################################
# add species information
########################################################
info = read.csv("./input/full-species-info-25-January-2019.csv")
nrow(info) ## 5897
length(unique(info$site_code)) # 108 sites

### this file contains information about species whether they are grass or Forb, C3 or C4, perennial or annual 

code_taxon_data = paste(toupper(leaf_core_spei$site_code), toupper(leaf_core_spei$Taxon), sep = ' ')

info_caps = mutate_all(info, .funs = toupper) ### transform all lower cases to upper cases 
names(info_caps)
info_caps$code_taxon = paste(info_caps$site_code, info_caps$standard_taxon, sep = ' ') #bind site_code to standard_taxon with space between them


n_info = NULL

for (i in 1:length(code_taxon_data)){
  
  ancillary_data = subset(info_caps, code_taxon == code_taxon_data[i])[, c(6:10)]
  
  ancillary_data$n = i
  
  n_info = rbind(n_info, ancillary_data)
  
}

leaf_core_spei_info = cbind(leaf_core_spei, n_info)
leaf_core_spei_info


#############################
## add in new growing season climate data
#############################

gs_climate <- read.csv("./input/cru_gs_climate.csv")
gs_climate

leaf_core_spei_info_gsclimate <- left_join(leaf_core_spei_info, gs_climate, by = c("site_code"))

write.csv(leaf_core_spei_info_gsclimate, "./output/leaf_core_spei_info_gsclimate.csv")
nrow(leaf_core_spei_info_gsclimate) #2788

###################################### add in species composition data ###############################################
######################################################################################################################
cover = read.csv("./input/full-cover-31-August-2020.csv")
names(cover)
nrow(cover) ## 239683

cover_select = select(cover, site_code, plot, year, Taxon, max_cover)

core_leaf_spei_cover = left_join(leaf_core_spei_info_gsclimate, cover_select)
nrow(core_leaf_spei_cover) # 2788
names(core_leaf_spei_cover)
names(leaf_core_spei_info_gsclimate)
####################################### load biomass data ##############################
full_biomass<-read.csv("./input/full-biomass-nutrients-06-December-2017.csv")
names(full_biomass)
length(unique(full_biomass$site_code)) ## 27
full_biomass$trt
########### for each site, block and plot, we have in this file data per category
#### forb, graminoid etc... not per species 

full_biomass[full_biomass == 'NULL'] <- NA # replace empty values by NA
full_biomass$pct_N <- as.numeric(full_biomass$pct_N)
sapply(full_biomass, class)

full_biomass$Ntrt = 0
full_biomass$Ntrt[full_biomass$trt == 'N' | full_biomass$trt == 'NP' | full_biomass$trt == 'NK' | full_biomass$trt == 'NPK' | full_biomass$trt == 'NPK+Fence'] = 1 # when N is added: Ntrt=1

full_biomass$Ptrt = 0
full_biomass$Ptrt[full_biomass$trt == 'P' | full_biomass$trt == 'NP' | full_biomass$trt == 'PK' | full_biomass$trt == 'NPK' | full_biomass$trt == 'NPK+Fence'] = 1 # when P is added: Ptrt=1

full_biomass$Ktrt = 0
full_biomass$Ktrt[full_biomass$trt == 'K' | full_biomass$trt == 'NK' | full_biomass$trt == 'PK' | full_biomass$trt == 'NPK' | full_biomass$trt == 'NPK+Fence'] = 1 # when K is added: Ktrt=1

full_biomass$Ntrt_fac = as.factor(full_biomass$Ntrt)
full_biomass$Ptrt_fac = as.factor(full_biomass$Ptrt)
full_biomass$Ktrt_fac = as.factor(full_biomass$Ktrt)


full_biomass$pct_C = as.numeric(as.character(full_biomass$pct_C))
full_biomass$pct_N = as.numeric(as.character(full_biomass$pct_N))
full_biomass$pct_P = as.numeric(as.character(full_biomass$pct_P))
full_biomass$pct_K = as.numeric(as.character(full_biomass$pct_K))
full_biomass$pct_Mg = as.numeric(as.character(full_biomass$pct_Mg))
full_biomass$pct_Ca = as.numeric(as.character(full_biomass$pct_Ca))


## AGN = above ground N!, mass is leaf mass
full_biomass$AGN <- full_biomass$mass*(full_biomass$pct_N*0.01) # calculation of aboveground N quatity

full_biomass$Nfix = 'no'
full_biomass$Nfix[full_biomass$category == 'LEGUME'] = 'yes' # set legumes as N fixers 

nrow(full_biomass) # 2102

biomass_core_leaf_spei = join(core_leaf_spei_cover, full_biomass, by = c("site_code", "year"), type = 'left', match = 'first')
names(biomass_core_leaf_spei)
nrow(biomass_core_leaf_spei) # 2788

core_leaf_spei_cover$Ntrt_fac
### add growing season length data#######################
gs_information <- read.csv("./input/Weather_site_inventory_20200921.csv")
head(gs_information)
colnames(gs_information)

gs_length <- gs_information[,c(2, 20)] ## selection of the colum site_code and gs_len

biomass_core_leaf_spei <- join(biomass_core_leaf_spei, gs_length, by = c("site_code"), type = 'left', match = 'first')

biomass_core_leaf_spei$site_code[is.na(biomass_core_leaf_spei$gs_len)]
biomass_core_leaf_spei$gs_len[biomass_core_leaf_spei$site_code == 'gilb.za'] <- 6
biomass_core_leaf_spei$gs_len[biomass_core_leaf_spei$site_code == 'summ.za'] <- 8

biomass_core_leaf_spei$gs_frac <- biomass_core_leaf_spei$gs_len / 12

###### add soil moisture data#######################
soil <- read.csv("./input/soil_data.csv")
biomass_core_leaf_spei <- join(biomass_core_leaf_spei, soil, by = c("site_code"), type = 'left', match = 'first')

write.csv(biomass_core_leaf_spei, "./output/biomass_core_leaf_spei_final.csv")
biomass_core_leaf_spei$max_cover

#################################### get PET and aridity index : mean annual variables between 1970 and 2000  ###############
#######################################################################################################################

########## Load necessary librairies ########
library(sf)
library(raster)
library(tmap)
library(mapview)

getwd()
setwd ("C:/Users/18632/Documents/Alissar/NutNet/NutNet_Ecology_Letters/input")
l = list.files(pattern = "v3_yr") #reading world maps containing the string mask in the crus_rasters (maps from jeff work)
l
################# loop to extract all the pixels (raster) from the world maps of PET data ############################# 
######## https://cgiarcsi.community/data/global-aridity-and-pet-database/################

l = list.files(pattern = "v3_yr")
l = c(l, list.files(pattern = "proj_elev", full.names = T)) # bring in new, projected elev data

r = list()
for(i in l){
  r1 = raster(i)
  r[[i]] = r1
  print(r1)
}

r = raster::stack(l)
crs(r) = 4326


records =  biomass_core_leaf_spei %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(crs = crs(r))

records = st_transform(records, crs = st_crs(r))
st_crs(records)==st_crs(r)


traits = cbind(records,
            raster::extract(r, st_coordinates(records), method = 'simple'))
traits

traits$Long = st_coordinates(traits)[,1]
traits$Lat = st_coordinates(traits)[,2]
st_geometry(traits) = NULL
traits$crs = 4326
names(traits)

colnames(traits)[colnames(traits) == "awi_pm_sr_yr"] <- "aridity"
traits$aridity= traits$aridity * 0.0001
hist(traits$aridity)
plot(traits$aridity, traits$SPEI_12)

setwd ("C:/Users/18632/Documents/Alissar/NutNet/NutNet_Ecology_Letters")
write.csv(traits, "./output/traits.csv")
hist(traits$aridity)
